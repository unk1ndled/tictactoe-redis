# 1. Build Stage
FROM golang:1.21-alpine AS builder

WORKDIR /app

# Initialize module if it doesn't exist, and download dependencies
COPY main.go .
RUN go mod init tictactoe || true
RUN go get github.com/gorilla/websocket
RUN go get github.com/redis/go-redis/v9
RUN go mod tidy

# Build the binary
RUN go build -o main main.go

# 2. Run Stage (Tiny image)
FROM alpine:latest
WORKDIR /root/

# Copy binary from builder
COPY --from=builder /app/main .

# Expose port
EXPOSE 8080

# Command to run
CMD ["./main"]